<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Añadir / Editar — Pastas Nonna</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f5f6f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .flag{height:8px;background:linear-gradient(90deg,#009246 33%,#fff 33% 66%,#ce2b37 66%)}
    .hero{background:#fff;border:1px solid #e5e5e5;border-radius:10px}
    .img-square{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;border:1px solid #eee;background:#fafafa}
    .btn-linea{border:1px solid #009246;color:#009246;background:transparent}
    .btn-linea:hover{background:#009246;color:#fff}
  </style>
</head>
<body>
  <div class="flag"></div>

  <div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 id="titulo">Nuevo producto</h4>
      <a href="admin.html" class="btn btn-outline-secondary btn-sm">← Volver a Admin</a>
    </div>

    <div class="row g-4 align-items-start">
      <!-- FORMULARIO -->
      <div class="col-12 col-md-7 col-lg-6">
        <div class="hero p-3">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input id="nombre" type="text" class="form-control" placeholder="Ej: Lasagna">
          </div>

          <div class="mb-3">
            <label class="form-label">Descripción <span class="text-danger">*</span></label>
            <textarea id="descripcion" class="form-control" rows="4" placeholder="Breve descripción del producto"></textarea>
          </div>

          <div class="row g-3">
            <div class="col-6">
              <label class="form-label">Precio (CLP)</label>
              <input id="precio" type="number" class="form-control" min="0" step="1" placeholder="5000">
            </div>
            <div class="col-6">
              <label class="form-label">Tipo</label>
              <select id="tipo" class="form-select">
                <option value="larga">Larga</option>
                <option value="corta">Corta</option>
                <option value="rellena">Rellena</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- IMAGEN + ACCIONES -->
      <div class="col-12 col-md-5 col-lg-4">
        <div class="hero p-3 mb-3">
          <label class="form-label">Imagen (cuadrada)</label>
          <img id="preview" class="img-square mb-2" alt="preview">
          <input id="file" type="file" accept="image/*" class="form-control">
          <div class="form-text">Se guardará dentro del navegador (DataURL).</div>
        </div>

        <div class="d-grid gap-2">
          <button id="btnGuardar" class="btn btn-success">Añadir</button>
          <button id="btnCancelar" class="btn btn-outline-secondary">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="flag"></div>

  <script>
    // ====== Storage helpers ======
    const LS_KEY = "productosCatalogo";
    const getCatalogo = () => JSON.parse(localStorage.getItem(LS_KEY) || "[]");
    const setCatalogo = (lista) => localStorage.setItem(LS_KEY, JSON.stringify(lista));

    // ====== Elementos ======
    const titulo = document.getElementById('titulo');
    const nombre = document.getElementById('nombre');
    const descripcion = document.getElementById('descripcion');
    const precio = document.getElementById('precio');
    const tipo = document.getElementById('tipo');
    const file = document.getElementById('file');
    const preview = document.getElementById('preview');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnCancelar = document.getElementById('btnCancelar');

    // ====== Modo (add/edit) por query ?id= #### ======
    const params = new URLSearchParams(location.search);
    const idEdit = params.get('id'); // null cuando es "añadir"
    let imgData = ""; // DataURL o ruta

    // Cargar datos si es edición
    if (idEdit) {
      const cat = getCatalogo();
      const prod = cat.find(p => String(p.id) === String(idEdit));
      if (prod) {
        titulo.textContent = "Editar producto";
        btnGuardar.textContent = "Guardar cambios";
        nombre.value = prod.nombre || "";
        descripcion.value = prod.descripcion || "";
        precio.value = prod.precio || 0;
        tipo.value = prod.tipo || "larga";
        imgData = prod.img || "";
        preview.src = imgData || "";
      }
    } else {
      // Nuevo producto
      titulo.textContent = "Nuevo producto";
      btnGuardar.textContent = "Añadir";
      preview.src = "";
    }

    // Subida de imagen -> a DataURL
    file.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        imgData = reader.result; // base64
        preview.src = imgData;
      };
      reader.readAsDataURL(f);
    });

    // Guardar
    btnGuardar.addEventListener('click', ()=>{
      const n = nombre.value.trim();
      const d = descripcion.value.trim();
      const pr = Math.max(0, parseInt(precio.value || "0", 10));
      const t = tipo.value || "larga";

      if (!d) {
        alert("Descripción obligatoria.");
        return;
      }

      // Genera key (slug) desde nombre
      const keyFrom = (s) => (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
      const cat = getCatalogo();

      if (idEdit) {
        // Editar existente
        const idx = cat.findIndex(p => String(p.id) === String(idEdit));
        if (idx > -1) {
          cat[idx] = {
            ...cat[idx],
            nombre: n || cat[idx].nombre,
            descripcion: d,
            precio: pr,
            tipo: t,
            key: keyFrom(n || cat[idx].nombre),
            img: imgData || cat[idx].img
          };
          setCatalogo(cat);
          alert("Cambios guardados.");
          location.href = "admin.html";
        }
      } else {
        // Añadir nuevo
        const nuevo = {
          id: Date.now(),
          key: keyFrom(n),
          nombre: n || "Nuevo producto",
          descripcion: d,
          precio: pr,
          tipo: t,
          img: imgData || ""  // si no sube imagen, quedará vacío
        };
        cat.push(nuevo);
        setCatalogo(cat);
        alert("Producto añadido.");
        location.href = "admin.html";
      }
    });

    btnCancelar.addEventListener('click', ()=> location.href="admin.html");
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
